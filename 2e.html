<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>MUS - EPISODE 2: POWER PLANT</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Courier New', monospace; }
        #game-container { width: 100%; height: 100%; position: relative; }
        #game-ui { position: absolute; top: 20px; left: 20px; color: #00ff00; text-shadow: 2px 2px 5px #000; pointer-events: none; z-index: 10; }
        #crosshair { position: absolute; top: 50%; left: 50%; width: 8px; height: 8px; border: 2px solid #fff; border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; z-index: 20; }
        #dialogue { position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); color: white; background: rgba(0,0,0,0.8); padding: 15px 30px; border: 1px solid #00ff00; display: none; z-index: 50; }
        #stamina-bar-container { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 200px; height: 8px; background: rgba(255,255,255,0.2); border: 1px solid #fff; }
        #stamina-bar { width: 100%; height: 100%; background: #ffdd44; }
        #esc-menu { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        .btn { background: transparent; border: 1px solid #0f0; color: #0f0; padding: 12px 25px; cursor: pointer; margin: 10px 0; display: block; width: 220px; font-family: inherit; font-size: 16px; text-align: center; }
        .btn:hover { background: #0f0; color: #000; }
        #fade-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: black; opacity: 0; z-index: 1000; pointer-events: none; }
        .fade-out { animation: fadeOut 2s forwards; }
        @keyframes fadeOut { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="game-ui">
            <h2 style="margin:0;">|MUS| EPISODE-2: 발전소</h2>
            <p id="objective">>>> [화면 클릭] 기어를 작동시켜 탈출하십시오.</p>
        </div>
        <div id="crosshair"></div>
        <div id="dialogue"></div>
        <div id="stamina-bar-container"><div id="stamina-bar"></div></div>
        <div id="esc-menu">
            <h1 style="color:#0f0; letter-spacing: 15px; margin-bottom:30px;">PAUSED</h1>
            <button class="btn" onclick="resumeGame()">계속하기</button>
            <button class="btn" onclick="saveAndExit()">저장 후 종료</button>
        </div>
        <div id="fade-overlay"></div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        let scene, camera, renderer, controls, raycaster;
        let moveState = { w: false, a: false, s: false, d: false, r: false };
        let velocity = new THREE.Vector3();
        let prevTime = performance.now();
        let stamina = 100;
        
        const colliders = []; // 충돌 판정 대상
        const interactables = [];
        let gearGroup, doorMesh;
        let isPowerOn = false;
        let doorOpen = false;

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x222222);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 8); 

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('game-container').appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.4));
            const light = new THREE.PointLight(0xffffff, 30, 20);
            light.position.set(0, 3, 2);
            scene.add(light);

            controls = new PointerLockControls(camera, document.body);
            document.getElementById('game-container').addEventListener('mousedown', () => { 
                if(!controls.isLocked) {
                    controls.lock();
                    if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
                } else { interact(); }
            });

            // --- 맵 제작 ---
            const wallMat = new THREE.MeshStandardMaterial({color: 0xaaaaaa});
            
            // 바닥/천장/벽
            const createBox = (w, h, d, x, y, z, mat, isCollider=true) => {
                const mesh = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), mat);
                mesh.position.set(x, y, z);
                scene.add(mesh);
                if(isCollider) colliders.push(new THREE.Box3().setFromObject(mesh));
                return mesh;
            };

            createBox(15, 0.1, 25, 0, -2.5, 0, wallMat); // 바닥
            createBox(15, 0.1, 25, 0, 4, 0, wallMat);    // 천장
            createBox(15, 7, 0.1, 0, 0.75, -12, wallMat); // 뒷벽
            createBox(0.1, 7, 25, -7.5, 0.75, 0, wallMat); // 왼벽
            createBox(0.1, 7, 25, 7.5, 0.75, 0, wallMat);  // 오른벽

            // --- 톱니바퀴 (Gear) 제작 ---
            gearGroup = new THREE.Group();
            const gearCenter = new THREE.Mesh(new THREE.CylinderGeometry(1.8, 1.8, 0.6, 16), new THREE.MeshStandardMaterial({color: 0x444444}));
            gearCenter.rotation.z = Math.PI / 2;
            gearGroup.add(gearCenter);

            // 톱니 조각 추가
            for(let i=0; i<12; i++){
                const tooth = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.8, 0.6), new THREE.MeshStandardMaterial({color: 0x333333}));
                tooth.position.y = 2.0 * Math.cos((i/12) * Math.PI * 2);
                tooth.position.z = 2.0 * Math.sin((i/12) * Math.PI * 2);
                tooth.rotation.x = -(i/12) * Math.PI * 2;
                gearGroup.add(tooth);
            }
            gearGroup.position.set(6.5, 0, -3);
            scene.add(gearGroup);
            gearGroup.userData = { msg: "거대한 기어다. 전력이 있으면 돌아갈 것 같다.", id: "gear" };
            interactables.push(gearGroup);
            colliders.push(new THREE.Box3().setFromObject(gearGroup));

            // --- 컴퓨터 콘솔 ---
            const comp = createBox(1, 2.5, 2, -6.8, -1.25, -3, new THREE.MeshStandardMaterial({color: 0x111111}));
            comp.userData = { msg: "메인 제어기: F를 눌러 전력을 활성화하십시오.", id: "computer" };
            interactables.push(comp);

            // --- 미닫이문 (Exit Door) ---
            doorMesh = new THREE.Mesh(new THREE.BoxGeometry(4, 5, 0.2), new THREE.MeshStandardMaterial({color: a7744d}));
            doorMesh.position.set(0, 0.5, -11.9);
            scene.add(doorMesh);

            raycaster = new THREE.Raycaster();
            window.addEventListener('keydown', (e) => { 
                if(e.code === 'KeyR') moveState.r = true;
                else moveState[e.code.replace('Key','').toLowerCase()] = true;
                if(e.code === 'KeyF') interact();
            });
            window.addEventListener('keyup', (e) => {
                if(e.code === 'KeyR') moveState.r = false;
                else moveState[e.code.replace('Key','').toLowerCase()] = false;
            });
        }

        function interact() {
            raycaster.setFromCamera(new THREE.Vector2(), camera);
            const hits = raycaster.intersectObjects(interactables, true);
            if (hits.length > 0 && hits[0].distance < 4) {
                let obj = hits[0].object;
                while(obj.parent && !obj.userData.id) obj = obj.parent;
                
                const diag = document.getElementById('dialogue');
                if(obj.userData.id === "computer") {
                    isPowerOn = true;
                    diag.innerText = "전력이 공급되었습니다! 기어가 돌아갑니다.";
                    document.getElementById('objective').innerText = ">>> 목표: 열린 문으로 탈출하십시오.";
                } else {
                    diag.innerText = obj.userData.msg;
                }
                diag.style.display = 'block';
                setTimeout(() => diag.style.display = 'none', 3000);
            }
        }

        function checkCollision(newPos) {
            const playerBox = new THREE.Box3().setFromCenterAndSize(newPos, new THREE.Vector3(0.8, 1.8, 0.8));
            for(let box of colliders) {
                if(playerBox.intersectsBox(box)) return true;
            }
            return false;
        }

        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now();
            const delta = Math.min((time - prevTime) / 1000, 0.1);

            if (controls.isLocked) {
                if(isPowerOn) {
                    gearGroup.rotation.x += 0.05;
                    if(doorMesh.position.x < 4) doorMesh.position.x += 0.05; // 미닫이문 열림
                }

                let speed = (moveState.r && stamina > 0) ? 2.0 : 1.0;
                if(moveState.r && (moveState.w || moveState.s)) stamina -= 30 * delta;
                else stamina = Math.min(100, stamina + 12 * delta);
                document.getElementById('stamina-bar').style.width = stamina + "%";

                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;
                const accel = 60.0;
                if (moveState.w) velocity.z -= accel * delta * speed;
                if (moveState.s) velocity.z += accel * delta * speed;
                if (moveState.a) velocity.x -= accel * delta * speed;
                if (moveState.d) velocity.x += accel * delta * speed;

                const nextPos = camera.position.clone();
                controls.moveRight(velocity.x * delta);
                controls.moveForward(-velocity.z * delta);

                // 충돌 시 이전 위치로 복구
                if(checkCollision(camera.position)) camera.position.copy(nextPos);

                // 탈출 조건
                if(isPowerOn && camera.position.z < -11) {
                    document.getElementById('fade-overlay').classList.add('fade-out');
                    setTimeout(() => window.location.href = "index.html", 2000);
                }
            }
            renderer.render(scene, camera);
            prevTime = time;
        }

        window.resumeGame = () => controls.lock();
        window.saveAndExit = () => window.location.href = "index.html";
    </script>
</body>
</html>
